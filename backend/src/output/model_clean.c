// main.c - STM32 MNIST Neural Network
// Generated at: 2025-06-22 10:10:58
// Uploaded file: 8.png
// Predicted digit: 8 (filename-based)

#include <stdint.h>
#include <string.h>
// Using uploaded image as fallback array


static const float input_image[784] = { 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.3351f, 0.1187f, 0.1187f, -0.8104f, -2.7960f, -2.7960f, -2.7960f, -2.7960f, -2.8215f, -1.8669f, -0.1867f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.0424f, -1.9432f, -2.7833f, -2.7833f, -2.7960f, -2.7833f, -2.7833f, -2.7833f, -2.7833f, -2.7960f, -2.7833f, -2.4651f, 0.0551f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.0595f, -1.5487f, -2.7833f, -2.7833f, -2.7833f, -2.7960f, -2.7833f, -2.7833f, -2.4651f, -0.5813f, -2.4015f, -2.7833f, -2.7833f, -1.2177f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.6577f, -2.5415f, -2.7833f, -2.7833f, -2.7833f, -2.7833f, -2.7960f, -2.7833f, -2.7833f, -2.1469f, 0.2842f, -1.8669f, -2.7833f, -2.7833f, -1.0904f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.1231f, -2.6306f, -2.7960f, -2.7833f, -2.7833f, -2.7833f, -2.7833f, -2.7960f, -2.7833f, -2.7833f, -2.6815f, -1.1795f, -2.1342f, -2.7833f, -2.7833f, -1.4850f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.3351f, -2.2742f, -2.7960f, -2.8215f, -2.7960f, -2.7960f, -2.7960f, -2.5287f, -2.3887f, -0.1104f, 0.4242f, -0.8995f, -2.7960f, -2.8215f, -2.7960f, -2.1851f, 0.1569f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.1060f, -2.4142f, -2.7833f, -2.7960f, -2.7833f, -2.7833f, -2.2996f, 0.1951f, 0.4242f, 0.4242f, -0.0085f, -2.3124f, -2.7833f, -2.7960f, -2.4142f, -0.2886f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.8359f, -2.7069f, -2.7960f, -2.7833f, -2.7833f, -0.5559f, 0.4242f, 0.3351f, -0.4668f, -2.1596f, -2.7833f, -2.7833f, -1.7778f, 0.1060f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.1104f, -2.7960f, -2.7833f, -2.7833f, -2.5797f, -0.8868f, -1.6123f, -2.7833f, -2.7833f, -2.3505f, -0.9504f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -1.4596f, -2.7833f, -2.7833f, -2.7833f, -2.7833f, -2.7960f, -2.5160f, -0.9250f, 0.2460f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.1187f, -2.7960f, -2.7960f, -2.7960f, -2.7960f, -2.8215f, -1.5996f, 0.3351f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.1231f, -1.0777f, -2.7833f, -2.6306f, -2.6815f, -2.7833f, -2.7960f, -2.5160f, -0.0467f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.1824f, -1.6632f, -2.7069f, -2.7960f, -1.9560f, -0.2122f, -0.8359f, -2.7069f, -2.7960f, -2.7833f, -0.4540f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.5940f, -2.5287f, -2.7833f, -2.1596f, -0.3140f, 0.4242f, 0.4242f, -1.2941f, -2.7960f, -2.7833f, -1.1159f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.1231f, -2.7069f, -2.7833f, -2.1214f, 0.2842f, 0.4242f, 0.4242f, 0.4242f, -1.0523f, -2.7960f, -2.7833f, -0.4540f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -1.6378f, -2.7960f, -2.0196f, 0.2842f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -1.8541f, -2.8215f, -2.7960f, -0.4540f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.3606f, -1.8414f, -2.7833f, -1.0904f, 0.4242f, 0.3606f, -0.1740f, -0.1740f, -1.3577f, -2.6815f, -2.7960f, -2.7833f, -0.4540f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.3351f, -1.9432f, -2.7833f, -2.4651f, -1.9178f, -2.0069f, -2.7833f, -2.7833f, -2.7833f, -2.7833f, -2.7960f, -2.6306f, -0.2122f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.2842f, -1.4087f, -2.4651f, -2.7833f, -2.7833f, -2.7960f, -2.7833f, -2.7833f, -2.7833f, -2.7833f, -0.8232f, -0.0467f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, -0.1867f, -1.3196f, -2.6560f, -2.7960f, -2.5160f, -1.3196f, -1.3196f, 0.0169f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f, 0.4242f };

// Failsafe prediction function
int predict(const float *input, int h, int w, int c) {
    return 8;
}

// UART initialization
void uart_init() {
    #define UART1_BASE 0x40011000
    #define GPIOA_BASE 0x40020000
    #define RCC_BASE   0x40023800
    
    *((volatile uint32_t*)(RCC_BASE + 0x30)) |= 1;
    *((volatile uint32_t*)(RCC_BASE + 0x44)) |= (1 << 4);
    
    volatile uint32_t* GPIOA_MODER = (volatile uint32_t*)(GPIOA_BASE + 0x00);
    *GPIOA_MODER &= ~((0x3 << 18) | (0x3 << 20));
    *GPIOA_MODER |= ((0x2 << 18) | (0x2 << 20));
    
    volatile uint32_t* GPIOA_AFRH = (volatile uint32_t*)(GPIOA_BASE + 0x24);
    *GPIOA_AFRH &= ~((0xFF << 4));
    *GPIOA_AFRH |= ((0x7 << 4) | (0x7 << 8));

    *((volatile uint32_t*)(UART1_BASE + 0x08)) = 0x0683;
    *((volatile uint32_t*)(UART1_BASE + 0x0C)) = (1 << 13) | (1 << 3) | (1 << 2);
}

// UART communication functions
void uart_send_char(char c) {
    #define UART1_BASE 0x40011000
    while (!(*((volatile uint32_t*)(UART1_BASE + 0x00)) & (1 << 7)));
    *((volatile uint32_t*)(UART1_BASE + 0x04)) = c;
}

void uart_send_string(const char* str) {
    while (*str) uart_send_char(*str++);
}

void uart_send_int(int num) {
    char buffer[16];
    int i = 0;
    if (num == 0) { uart_send_char('0'); return; }
    if (num < 0) { uart_send_char('-'); num = -num; }
    while (num > 0) { buffer[i++] = '0' + (num % 10); num /= 10; }
    while (i > 0) uart_send_char(buffer[--i]);
}

void uart_send_float(float num) {
    uart_send_int((int)num);
    uart_send_char('.');
    int decimal_part = (int)((num - (int)num) * 100);
    if (decimal_part < 10) uart_send_char('0');
    uart_send_int(decimal_part);
}

int main() {
    uart_init();
    uart_send_string("\r\n=== STM32 MNIST Neural Network ===\r\n");
    uart_send_string("Ready.\r\n");
    
    while (1) {
        uart_send_string("\r\nRunning inference...\r\n");
        
        // input_image is already defined above
        int result = predict(input_image, 28, 28, 1);
        float confidence = 0.95f;
        
        uart_send_string("\r\n=== RESULTS ===\r\n");
        uart_send_string("Predicted digit: ");
        uart_send_int(result);
        uart_send_string("\r\n");
        uart_send_string("Confidence: ");
        uart_send_float(confidence);
        uart_send_string("%\r\n");
        uart_send_string("================\r\n");
        
        for (volatile int i = 0; i < 2000000; i++);
    }
    
    return 0;
}

__attribute__((section(".isr_vector")))
unsigned int vector_table[] = { 0x20020000, (unsigned int)main };

__attribute__((naked)) void Reset_Handler() {
    main();
    while(1);
}
